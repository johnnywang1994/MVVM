(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self,t.Webc=e())})(this,function(){"use strict";function t(t){this.$data=t,this.observe(this.$data)}function e(){this.subs=[]}function n(t,e,n){this.$vm=t,this.$exp=e,this.$cb=n,this.init()}function o(t,{vm:e,prefix:n}){this.$el=this.isElementNode(t)?t:document.querySelector(t),this.$vm=e,this.$prefix=n,this.$el&&this.init()}function i(t,e){return this.$tagName=t,this.$opts=e,this.$webcomponent=null,this.init(),this.$webcomponent}return t.prototype={observe(t){const e=this;t&&"object"==typeof t&&Object.keys(t).forEach(n=>{e.defineReactive(t,n,t[n])})},defineReactive(t,n,o){const i=this,s=new e;i.observe(o),Object.defineProperty(t,n,{enumerable:!0,configurable:!1,get:()=>(e.target&&s.addSub(e.target),o),set(t){t!==o&&(o=t,i.observe(t),s.notify())}})}},e.prototype={addSub(t){this.subs.push(t)},notify(){this.subs.forEach(t=>t.update())}},n.prototype={update(){this.run()},init(){this._hasInit=!1,this.value=this.get(),this._hasInit=!0},run(){const t=this.get(),e=this.value;t!==e&&(this.value=t,this.$cb.call(this.$vm,t,e))},get(){!this._hasInit&&(e.target=this);const t=this._getVMVal(this.$exp);return e.target=null,t},_getVMVal(t){let e=this.$vm;return t=t.split("."),t.forEach(t=>{e=e[t]}),e}},o.prototype={init(){this.compileElement(this.$el)},compileElement(t){const e=t.childNodes,n=this;e.forEach(t=>{n.isElementNode(t)?n.compile(t):n.isTextNode(t)&&n.compileText(t),n.hasChildNodes(t)&&n.compileElement(t)})},compile(t){const e=t.attributes,o=this;[...e].forEach(e=>{const i=e.name;if(o.isDirective(i)){const s=i.substring(o.$prefix.length+1),r=e.value.trim();o.isEventDirective(s)?o.directives.eventHandler(t,o._getVMVal(r),s,o.$vm):(o.directives[s](t,o._getVMVal(r)),new n(this.$vm,r,function(e){o.directives[s](t,e)})),t.removeAttribute(i)}})},compileText(t){const e=t.textContent.trim(),o=this,i=/\{\{(.*)\}\}/;if(i.test(e)){const{exps:i,value:s}=o.renderText(e,o.$vm);o.directives.text(t,s),i.forEach(i=>{new n(this.$vm,i,function(){const{value:n}=o.renderText(e,o.$vm);o.directives.text(t,n)})})}},renderText(t,e){const n=this;let o=null;t=String(t);const i=function(t){const e=/\{\{\s*([^\}]+)?\s*\}\}/g;return o=n.removeWrapper(t.match(e)),t=t.replace(e,'" + data.$1 + "'),new Function("data",'return "'+t+'";')};let s=i(t);return{exps:o,value:s(e)}},removeWrapper(t){let e=[];return t.forEach(t=>{e.push(t.replace(/[\{|\}]/g,"").trim())}),e},isElementNode:t=>1===t.nodeType,isTextNode:t=>3===t.nodeType,isDirective(t){return 0==t.indexOf(this.$prefix)},isEventDirective:t=>0===t.indexOf("on"),hasChildNodes:t=>t.childNodes&&t.childNodes.length,_getVMVal(t){let e=this.$vm;return t=t.split("."),t.forEach(t=>{e=e[t]}),e},directives:{text(t,e){t.textContent=e},html(t,e){t.innerHTML=e},replace(t,e){t.parentNode.replaceChild(e,t)},show(t,e){t.style.display=Boolean(e)?null:"none"},eventHandler(t,e,n,o){const i=n.split(":")[1],s=e;i&&s&&t.addEventListener(i,s.bind(o),!1)}}},i.getModule=function(t){return i.prototype.$modules[t]},i.getComponent=function(t){return i.prototype.$components[t]},i.prototype={init(){this.defineTag(),this.setModule(this.$tagName,this.$webcomponent)},defineTag(){const e=this;let{html:n,prefix:i="w"}=e.$opts;n=e.renderComponent(n),e.$webcomponent=class extends HTMLElement{constructor(s){super();const r=this.$options=s||{},{name:c,data:h,computed:a,methods:p,components:l,customize:d}=r;this.$data=h||{},this.$computed=a,this.$methods=p,this.$components=l,this.$el=e.getNode(n),this.$root=this.initRoot(this,r),this.$vm=Object.create(null),e.walk(this.$data,t=>e._proxyData(this,t)),e.walk(this.$computed,t=>e._proxyComputed(this,t)),e.walk(this.$methods,t=>e._proxyMethods(this,t)),e.walk(this.$components,t=>e._proxyComponents(this,t)),new t(this.$data),new o(this.$el,{vm:this.$vm,prefix:i}),this.insertStyle(this.$root,r),d&&"funciton"==typeof d&&d.call(this),this.$root.appendChild(this.$el),e.setComponent(c||e.$tagName,this)}initRoot(t,e){const n=document.head.attachShadow&&e.shadow;return n?t.attachShadow({mode:"open"}):t}insertStyle(t,e){if(e.stylesheet){const n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("href",e.stylesheet),t.appendChild(n)}}},customElements.define(e.$tagName,e.$webcomponent)},getNode:t=>(new DOMParser).parseFromString(t,"text/html").body.childNodes[0],renderComponent(t){t=String(t);const e=function(t){const e=/<%\s*([^%>]+)?\s*%>/g;return t=t.replace(e,'<span w-replace="$1"></span>'),t};return e(t)},walk(t,e){if(t)return Object.keys(t).forEach(e)},_proxyData(t,e){Object.defineProperty(t.$vm,e,{enumerable:!0,configurable:!1,get:()=>t.$data[e],set(n){t.$data[e]=n}})},_proxyComputed(t,e){const n=t.$computed;Object.defineProperty(t.$vm,e,{get:"function"==typeof n[e]?n[e]:n[e].get,set:"function"!=typeof n[e]?n[e].set:function(){}})},_proxyMethods(t,e){const n=t.$methods;Object.defineProperty(t.$vm,e,{get:"function"==typeof n[e]?()=>n[e]:function(){}})},_proxyComponents(t,e){Object.defineProperty(t.$vm,e,{enumerable:!0,configurable:!1,get:()=>t.$components[e]})},$modules:{},$components:{},setModule:(t,e)=>i.prototype.$modules[t]=e,setComponent:(t,e)=>i.prototype.$components[t]=e},i});