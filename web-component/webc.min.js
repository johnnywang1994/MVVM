(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self,t.Webc=e())})(this,function(){"use strict";function t(t){this.$data=t,this.observe(this.$data)}function e(){this.subs=[]}function i(t,e,i){this.$vm=t,this.$exp=e,this.$cb=i,this.init()}function n(t,{vm:e,prefix:i}){this.$el=this.isElementNode(t)?t:document.querySelector(t),this.$vm=e,this.$prefix=i,this.$el&&this.init()}function s(t,e){return this.$tagName=t,this.$opts=e,this.$webcomponent=null,this.init(),this.$webcomponent}return t.prototype={observe(t){const e=this;t&&"object"==typeof t&&Object.keys(t).forEach(i=>{e.defineReactive(t,i,t[i])})},defineReactive(t,i,n){const s=this,o=new e;s.observe(n),Object.defineProperty(t,i,{enumerable:!0,configurable:!1,get:()=>(e.target&&o.addSub(e.target),n),set(t){t!==n&&(n=t,s.observe(t),o.notify())}})}},e.prototype={addSub(t){this.subs.push(t)},notify(){this.subs.forEach(t=>t.update())}},i.prototype={update(){this.run()},init(){this._hasInit=!1,this.value=this.get(),this._hasInit=!0},run(){const t=this.get(),e=this.value;t!==e&&(this.value=t,this.$cb.call(this.$vm,t,e))},get(){!this._hasInit&&(e.target=this);const t=this._getVMVal(this.$exp);return e.target=null,t},_getVMVal(t){let e=this.$vm;return t=t.split("."),t.forEach(t=>{e=e[t]}),e}},n.prototype={init(){this.compileElement(this.$el)},compileElement(t){const e=t.childNodes,i=this;e.forEach(t=>{i.isElementNode(t)?i.compile(t):i.isTextNode(t)&&i.compileText(t),i.hasChildNodes(t)&&i.compileElement(t)})},compile(t){const e=t.attributes,n=this;[...e].forEach(e=>{const s=e.name;if(n.isDirective(s)){const o=s.substring(n.$prefix.length+1),r=e.value.trim();n.isEventDirective(o)?n.directives.eventHandler(t,n._getVMVal(r),o,n.$vm):(n.directives[o](t,n._getVMVal(r)),new i(this.$vm,r,function(e){n.directives[o](t,e)})),t.removeAttribute(s)}})},compileText(t){const e=t.textContent.trim(),n=this,s=/\{\{(.*)\}\}/;if(s.test(e)){const{exps:s,value:o}=n.renderText(e,n.$vm);n.directives.text(t,o),s.forEach(s=>{new i(this.$vm,s,function(){const{value:i}=n.renderText(e,n.$vm);n.directives.text(t,i)})})}},renderText(t,e){const i=this;let n=null;t=String(t);const s=function(t){const e=/\{\{\s*([^\}]+)?\s*\}\}/g;return n=i.removeWrapper(t.match(e)),t=t.replace(e,'" + data.$1 + "'),new Function("data",'return "'+t+'";')};let o=s(t);return{exps:n,value:o(e)}},removeWrapper(t){let e=[];return t.forEach(t=>{e.push(t.replace(/[\{|\}]/g,"").trim())}),e},isElementNode:t=>1===t.nodeType,isTextNode:t=>3===t.nodeType,isDirective(t){return 0==t.indexOf(this.$prefix)},isEventDirective:t=>0===t.indexOf("on"),hasChildNodes:t=>t.childNodes&&t.childNodes.length,_getVMVal(t){let e=this.$vm;return t=t.split("."),t.forEach(t=>{e=e[t]}),e},directives:{text(t,e){t.textContent=e},html(t,e){t.innerHTML=e},replace(t,e){t.parentNode.replaceChild(e,t)},show(t,e){t.style.display=Boolean(e)?null:"none"},eventHandler(t,e,i,n){const s=i.split(":")[1],o=e;s&&o&&t.addEventListener(s,o.bind(n),!1)}}},s.prototype={init(){this.defineTag()},defineTag(){const e=this;let{html:i,prefix:s="w"}=e.$opts;i=e.renderComponent(i),e.$webcomponent=class extends HTMLElement{constructor(o){super();const r=this.$options=o||{},{data:c,computed:h,methods:a,components:l,customize:d}=r;this.$data=c||{},this.$computed=h,this.$methods=a,this.$components=l,this.$el=e.getNode(i),this.$root=this.initRoot(this,r),this.$vm=Object.create(null),e.walk(this.$data,t=>e._proxyData(this,t)),e.walk(this.$computed,t=>e._proxyComputed(this,t)),e.walk(this.$methods,t=>e._proxyMethods(this,t)),e.walk(this.$components,t=>e._proxyComponents(this,t)),new t(this.$data),new n(this.$el,{vm:this.$vm,prefix:s}),this.insertStyle(this.$root,r),d&&"funciton"==typeof d&&d.call(this),this.$root.appendChild(this.$el)}initRoot(t,e){const i=document.head.attachShadow&&e.shadow;return i?t.attachShadow({mode:"open"}):t}insertStyle(t,e){if(e.stylesheet){const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",e.stylesheet),t.appendChild(i)}}},customElements.define(e.$tagName,e.$webcomponent)},getNode:t=>(new DOMParser).parseFromString(t,"text/html").body.childNodes[0],renderComponent(t){t=String(t);const e=function(t){const e=/<%\s*([^%>]+)?\s*%>/g;return t=t.replace(e,'<span w-replace="$1"></span>'),t};return e(t)},walk(t,e){if(t)return Object.keys(t).forEach(e)},_proxyData(t,e){Object.defineProperty(t.$vm,e,{enumerable:!0,configurable:!1,get:()=>t.$data[e],set(i){t.$data[e]=i}})},_proxyComputed(t,e){const i=t.$computed;Object.defineProperty(t.$vm,e,{get:"function"==typeof i[e]?i[e]:i[e].get,set:"function"!=typeof i[e]?i[e].set:function(){}})},_proxyMethods(t,e){const i=t.$methods;Object.defineProperty(t.$vm,e,{get:"function"==typeof i[e]?()=>i[e]:function(){}})},_proxyComponents(t,e){Object.defineProperty(t.$vm,e,{enumerable:!0,configurable:!1,get:()=>t.$components[e]})}},s});